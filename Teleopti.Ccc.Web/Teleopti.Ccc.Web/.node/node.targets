<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
	<PropertyGroup>
		<SolutionDir Condition="$(SolutionDir) == '' Or $(SolutionDir) == '*Undefined*'">$(MSBuildProjectDirectory)\..\</SolutionDir>

		<!-- Node Directory  -->
		<NodeDir>$(MSBuildProjectDirectory)\.node\</NodeDir>

		<!-- Path to Node.exe -->
		<NodeCmd>$(NodeDir)node</NodeCmd>

		<!-- Path to npm command -->
		<NpmCmd>$(NodeDir)npm</NpmCmd>

		<!-- Path to grunt command -->
		<GruntCmd>$(NodeDir)grunt</GruntCmd>

		<!-- Grunt Build Command -->
		<GruntBuild>"$(GruntCmd)" dist --verbose --no-color </GruntBuild>

		<!-- NPM install command -->
		<NpmInstallCmd>"$(NpmCmd)" update</NpmInstallCmd>

		<!-- NPM flatten command -->
		<NpmFlattenCmd>$(NodeDir)flatten-packages</NpmFlattenCmd>
		<NpmInstallFlattenPackages>"$(NpmCmd)" install -g flatten-packages -save-dev</NpmInstallFlattenPackages>
		
		<!-- Protractor install command -->
		<NpmInstallProtractorCmd>"$(NpmCmd)" update -g protractor -save-dev</NpmInstallProtractorCmd>

		<!-- kss install command -->
		<NpmInstallKssCmd>"$(NpmCmd)" install -g kss -save-dev</NpmInstallKssCmd>
		<KssGenerateStyleGuide>$(NodeDir)kss-node $(MSBuildProjectDirectory)\WFM\css $(MSBuildProjectDirectory)\WFM\styleguide $(MSBuildProjectDirectory)\WFM\css\styleguide.md --template $(MSBuildProjectDirectory)\WFM\wfm-template</KssGenerateStyleGuide>

		<!-- grunt-cli install command -->
		<NpmInstallGruntCliCmd>"$(NpmCmd)" install -g grunt-cli -save-dev</NpmInstallGruntCliCmd>
	</PropertyGroup>

	<!-- Runs NPM command -->
	<Target Name="RestoreNodePackages">
		<Message Text="Restore Node Packages Command: $(NpmInstallCmd) /w WorkingDirectory: $(MSBuildProjectDirectory)\WFM" Importance="high" />
		<Exec Command="$(NpmInstallCmd)" ContinueOnError="false" WorkingDirectory="$(MSBuildProjectDirectory)\WFM" />
		<Message Text="Install Flatten Node Packages Command: $(NpmInstallFlattenPackages) /w WorkingDirectory: $(MSBuildProjectDirectory)\WFM" Importance="high" />
		<Exec Command="$(NpmInstallFlattenPackages)" ContinueOnError="false" WorkingDirectory="$(NodeDir)" />
		<Message Text="Flatten Node Packages Command: $(NpmFlattenCmd) /w WorkingDirectory: $(MSBuildProjectDirectory)\WFM" Importance="high" />
		<Exec Command="$(NpmFlattenCmd)" ContinueOnError="false" WorkingDirectory="$(MSBuildProjectDirectory)\WFM" />
		<Message Text="HACK! Removing directory to get below 260 characters" Importance="high" />
		<Exec Command="rmdir /S /Q $(MSBuildProjectDirectory)\WFM\node_modules\node-sass\test" />
	</Target>

	<!-- Run node-kss to build the style guide -->
	<ItemGroup>
		<CssFiles Include="$(MSBuildProjectDirectory)\WFM\css\**\*" Exclude="main.*" />
		<TemplateFiles Include="$(MSBuildProjectDirectory)\WFM\wfm-template\**\*" />
		<StyleguideFiles Include="$(MSBuildProjectDirectory)\WFM\styleguide;$(MSBuildProjectDirectory)\Areas\WFM\styleguide\**\*" />
		<MainCssFiles Include="$(MSBuildProjectDirectory)\WFM\css\**\main.*" />
	</ItemGroup>
	<Target Name="BuildStyleGuide" Inputs="@(CssFiles);@(TemplateFiles);@(MainCssFiles)" Outputs="@(StyleguideFiles)">
		<Message Text="Restore Node Packages Command: $(NpmInstallKssCmd) /w WorkingDirectory: $(NodeDir)" Importance="high" />
		<Exec Command="$(NpmInstallKssCmd)" ContinueOnError="false" WorkingDirectory="$(NodeDir)" />
		<Message Text="Build Style Guide Command: $(KssGenerateStyleGuide) /w WorkingDirectory: $(MSBuildProjectDirectory)\WFM" Importance="high" />
		<Exec Command="$(KssGenerateStyleGuide)" ContinueOnError="false" WorkingDirectory="$(MSBuildProjectDirectory)\WFM" />
	</Target>
	
	<!-- Install protractor -->
	<Target Name="RestoreNodePackageProtractor">
		<Message Text="Restore Node Packages Command: $(NpmInstallProtractorCmd) /w WorkingDirectory: $(NodeDir)" Importance="high" />
		<Exec Command="$(NpmInstallProtractorCmd)" ContinueOnError="false" WorkingDirectory="$(NodeDir)" />
	</Target>

	<!-- Executes Build -->
	<ItemGroup>
		<OriginalJsFiles Include="$(MSBuildProjectDirectory)\WFM\js\**\*.js" />
		<SassFiles Include="$(MSBuildProjectDirectory)\WFM\css\**\*.scss" />
		<DistCssFiles Include="$(MSBuildProjectDirectory)\WFM\css\main.css" />
		<DistJsFiles Include="$(MSBuildProjectDirectory)\WFM\dist;$(MSBuildProjectDirectory)\WFM\dist\**\*" />
	</ItemGroup>
	<Target Name="RunGruntBuild" Inputs="@(OriginalJsFiles);@(SassFiles)" Outputs="@(DistJsFiles);@(DistCssFiles)">
		<Message Text="Restore Node Packages Command: $(NpmInstallGruntCliCmd) /w WorkingDirectory: $(NodeDir)" Importance="high" />
		<Exec Command="$(NpmInstallGruntCliCmd)" ContinueOnError="false" WorkingDirectory="$(NodeDir)" />
		<Message Text="Executing Node.JS Builds: $(GruntBuild) /w WorkingDirectory: $(MSBuildProjectDirectory)\WFM" Importance="high" />
		<Exec ContinueOnError="false" WorkingDirectory="$(MSBuildProjectDirectory)\WFM" Command="$(GruntBuild)" />
	</Target>
</Project>